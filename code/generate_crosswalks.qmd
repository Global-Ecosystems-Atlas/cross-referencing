---
title: "Convert membership matrices to crosswalk tables"
author: "Ben Cresswell"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
 html_document:
    code_folding: show
    collapse: no
    df_print: paged
    fig_caption: yes
    fig_height: 6
    fig_width: 10
    highlight: textmate
    theme: spacelab
    toc: yes
    toc_float: yes
editor_options: 
  chunk_output_type: inline
---


```{r setup, include=FALSE}
# Set options, housekeeping
knitr::opts_chunk$set(
	echo = FALSE,
	include = TRUE,
	message = FALSE,
	warning = FALSE)
```


# Introduction
This file converts completed membership matrix templates into crosswalk tables for the Atlas synthesis process.


# Housekeeping
```{r}
# Load required libraries
library(glue) #for string manipulation
library(fs) #for file system operations
library(readxl)  #for reading excel files
library(googlesheets4) #for reading google sheets
library(tidyverse)  #for data wrangling etc
rm(list=ls())
```


# Load efg information
Need both pixel values and efg codes as separate objects for pipeline
### Pixel values
```{r}
efg_pixelvalues <- read_csv(
  "https://raw.githubusercontent.com/Global-Ecosystems-Atlas/metadata/refs/heads/main/pixel-values/efg_pixelvalues.csv",
  show_col_types = FALSE) |>
  rename(efg_code = EFG_Code,
         efg_name = EFG_Name,
         efg_description = EFG,
         pixel_value = PixelValue) |> 
  mutate(efg_code = as.character(efg_code)) |> 
  mutate(efg_code = replace_na(efg_code, "NA"))
```


### EFG codes
```{r}
efg_codes <- efg_pixelvalues |>
  pull(efg_code) |> 
  unique()
```



# Specify input and output directories
```{r}
input_folder <- here::here("resources/02-membership-matrix-complete")
output_folder <- here::here("resources/03_cw_tables_GEA")
dir_create(output_folder)
```


# Function to process membership matrix template for one dataset
```{r}
process_membmat <- function(file_path, membership_threshold = 0.5) { # Set membership threshold here. Currently 0.5 (50%)
  
  # Derive data_id_code from folder name
  data_id <- basename(dirname(file_path))
  
  # Read membership matrix
  # Trying to coerce these all to the same var types for downstream work but fails on reload, so need a fix there...
dat <- read_csv(file_path, show_col_types = FALSE) |>
  mutate(
    crossref_date               = as.character(crossref_date),
    crossref_by                 = as.character(crossref_by),
    data_id_code                = as.character(data_id_code),
    band_layer_name             = as.character(band_layer_name),
    in_class_field_name         = as.character(in_class_field_name),
    in_class_value              = as.character(in_class_value),
    in_class_description        = as.character(in_class_description),
    in_class_description_detail = as.character(in_class_description_detail),
    GET_vsn                     = as.double(GET_vsn),
    Source_ID                   = as.double(Source_ID)
  )  
  # Pivot longer across all EFG codes
  dat_long <- dat |>
    pivot_longer(
      cols = all_of(efg_codes),
      names_to = "efg_code",
      values_to = "membership"
    )
  
  # Split into majority and no-majority cases
  dat_majority <- dat_long |>
    filter(!is.na(membership), membership > membership_threshold)
  
  dat_no_majority <- dat_long |>
    group_by(
      crossref_date,
      crossref_by,
      GET_vsn,
      Source_ID,
      data_id_code,
      band_layer_name,
      in_class_field_name,
      in_class_value,
      in_class_description,
      in_class_description_detail
    ) |>
    summarise(
      has_majority = any(membership > membership_threshold, na.rm = TRUE),
      .groups = "drop"
    ) |>
    filter(!has_majority) |>
    mutate(
      efg_code   = NA_character_,
      membership = NA_real_
    )
  
  # Combine
  dat_out <- bind_rows(
    dat_majority,
    dat_no_majority
  )
  
  # Join with metadata (will yield NA for EFG fields)
  dat_out <- dat_out |>
    left_join(efg_pixelvalues, by = "efg_code") |>
    mutate(
      pixel_value = if_else(is.na(efg_code), 255L, pixel_value),
      efg_name = if_else(
        is.na(efg_code),
        "No Data",
        efg_name
      ),
      efg_description = if_else(
        is.na(efg_code),
        "NA No Data",
        efg_description
      )
    )  |>
    select(
      crossref_date,
      crossref_by,
      GET_vsn,
      Source_ID,
      data_id_code,
      band_layer_name,
      in_class_field_name,
      in_class_value,
      in_class_description,
      in_class_description_detail,
      efg_code,
      efg_name,
      efg_description,
      pixel_value
    ) |>
    arrange(data_id_code, band_layer_name, in_class_value)
  
  
  
  # Define output subdir and ensure it exists
  sub_dir <- path(output_folder, data_id)
  dir_create(sub_dir)
  
  # Save
  save_path <- path(sub_dir, glue::glue("{data_id}_GEA_crosswalk_table.csv"))
  write_csv(dat_out, save_path)
  
  message("Processed: ", data_id)
}
```

# Process all membership matrix files
```{r}
dir_ls(input_folder, recurse = TRUE, regexp = "-membmat-complete\\.csv$") |>
  walk(process_membmat)
```

```{r}
# END
```

